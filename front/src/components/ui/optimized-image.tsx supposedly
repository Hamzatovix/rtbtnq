'use client'

import Image from 'next/image'
import { useState } from 'react'
import { useInView } from 'react-intersection-observer'

interface OptimizedImageProps {
  src: string
  alt: string
  fill?: boolean
  width?: number
  height?: number
  sizes?: string
  className?: string
  priority?: boolean
  placeholder?: 'blur' | 'empty'
  blurDataURL?: string
  onLoad?: () => void
  onError?: () => void
}

export function OptimizedImage({
  src,
  alt,
  fill = false,
  width,
  height,
  sizes,
  className = '',
  priority = false,
  placeholder = 'empty',
  blurDataURL,
  onLoad,
  onError,
}: OptimizedImageProps) {
  const [isLoaded, setIsLoaded] = useState(false)
  const [hasError, setHasError] = useState(false)
  
  const { ref, inView } = useInView({
    threshold: 0.1,
    triggerOnce: true,
  })

  const handleLoad = () => {
    setIsLoaded(true)
    onLoad?.()
  }

  const handleError = () => {
    setHasError(true)
    onError?.()
  }

  // Для fill изображений - родительский контейнер уже имеет position: relative и размеры
  if (fill) {
    return (
      <>
        {(!inView && !priority) ? (
          <div 
            ref={ref}
            className={`absolute inset-0 bg-gray-200 animate-pulse ${className}`}
          />
        ) : (
          <>
            <Image
              src={hasError ? '/placeholder/about_main_placeholder.webp' : src}
              alt={alt}
              fill
              sizes={sizes}
              priority={priority || inView}
              placeholder={placeholder}
              blurDataURL={blurDataURL}
              onLoad={handleLoad}
              onError={handleError}
              className={`${className} transition-opacity duration-300 ${
                isLoaded ? 'opacity-100' : 'opacity-0'
              }`}
            />
            {!isLoaded && !hasError && (
              <div className="absolute inset-0 bg-gray-200 animate-pulse pointer-events-none" />
            )}
          </>
        )}
      </>
    )
  }

  // Для фиксированных размеров
  return (
    <div ref={ref as any} className={`relative ${className}`}>
      {(!inView && !priority) ? (
        <div 
          className="bg-gray-200 animate-pulse"
          style={{ width, height }}
        />
      ) : (
        <>
          <Image
            src={hasError ? '/placeholder/about_main_placeholder.webp' : src}
            alt={alt}
            width={width}
            height={height}
            sizes={sizes}
            priority={priority}
            placeholder={placeholder}
            blurDataURL={blurDataURL}
            onLoad={handleLoad}
            onError={handleError}
            className={`transition-opacity duration-300 ${
              isLoaded ? 'opacity-100' : 'opacity-0'
            }`}
          />
          {!isLoaded && !hasError && (
            <div className="absolute inset-0 bg-gray-200 animate-pulse" />
          )}
        </>
      )}
    </.base>
  )
}

